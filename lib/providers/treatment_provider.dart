// v1.3.0 - üìù ‡∏≠‡∏±‡∏õ‡πÄ‡∏Å‡∏£‡∏î‡πÉ‡∏´‡πâ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Treatment Notes
// v1.2.0 - üñºÔ∏è ‡∏≠‡∏±‡∏õ‡πÄ‡∏Å‡∏£‡∏î‡πÉ‡∏´‡πâ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û
import 'dart:io';
import 'package:flutter/material.dart';
import '../models/treatment.dart';
import '../services/treatment_service.dart';
import '../services/treatment_master_service.dart';

class TreatmentProvider with ChangeNotifier {
  final TreatmentService _treatmentService = TreatmentService();

  bool _isLoading = false;
  bool get isLoading => _isLoading;

  String? _error;
  String? get error => _error;

  void _setLoading(bool value) {
    _isLoading = value;
    notifyListeners();
  }

  void _setError(String? message) {
    _error = message;
  }

  /// [UPGRADED v1.3.0] ‡πÄ‡∏°‡∏ò‡∏≠‡∏î‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤"
  /// ‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏£‡∏±‡∏ö Treatment object ‡∏ó‡∏±‡πâ‡∏á‡∏Å‡πâ‡∏≠‡∏ô ‡∏ã‡∏∂‡πà‡∏á‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• notes ‡∏≠‡∏¢‡∏π‡πà‡∏Ç‡πâ‡∏≤‡∏á‡πÉ‡∏ô‡πÅ‡∏•‡πâ‡∏ß
  /// ‡πÅ‡∏•‡∏∞‡∏¢‡∏±‡∏á‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏ô‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û (images) ‡πÑ‡∏õ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ô‡∏î‡πâ‡∏ß‡∏¢
  Future<bool> saveTreatment({
    required String patientId,
    required Treatment treatment,
    bool isEditing = false,
    List<File>? images,
  }) async {
    _setLoading(true);
    _setError(null);

    try {
      // 1. ‡πÄ‡∏ä‡πá‡∏Ñ‡πÅ‡∏•‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏±‡∏ï‡∏ñ‡∏Å‡∏≤‡∏£‡∏•‡∏á‡πÉ‡∏ô Master Data (‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ)
      final masterId = await TreatmentMasterService.addIfNotExist(treatment.procedure, treatment.price);
      
      // 2. ‡∏™‡∏£‡πâ‡∏≤‡∏á object ‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤‡πÉ‡∏´‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ö Master ID ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
      // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• notes ‡∏ó‡∏µ‡πà‡∏°‡∏≤‡∏à‡∏≤‡∏Å‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏à‡∏∞‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô treatment object ‡∏ô‡∏µ‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß
      final treatmentToSave = treatment.copyWith(treatmentMasterId: masterId);

      // 3. ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ Service ‡πÉ‡∏´‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
      if (isEditing) {
        await _treatmentService.updateTreatment(
          patientId,
          treatmentToSave,
          newImages: images,
        );
      } else {
        await _treatmentService.addTreatment(
          patientId,
          treatmentToSave,
          images: images,
        );
      }

      _setLoading(false);
      return true; // ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!
    } catch (e) {
      debugPrint('üßë‚Äçüç≥‚ùå ‡∏û‡πà‡∏≠‡∏Ñ‡∏£‡∏±‡∏ß‡∏ó‡∏≥‡∏û‡∏•‡∏≤‡∏î: $e');
      _setError('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏∞: $e');
      _setLoading(false);
      return false; // ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß
    }
  }
  
  /// ‡πÄ‡∏°‡∏ô‡∏π‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö "‡∏•‡∏ö‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏Ç‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤"
  Future<bool> deleteTreatmentImage({
    required String patientId,
    required String treatmentId,
    required String imageUrl,
  }) async {
    _setLoading(true);
    _setError(null);
    try {
      await _treatmentService.deleteTreatmentImage(
        patientId: patientId,
        treatmentId: treatmentId,
        imageUrl: imageUrl,
      );
      _setLoading(false);
      return true; // ‡∏•‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!
    } catch (e) {
      debugPrint('üßë‚Äçüç≥‚ùå ‡∏û‡πà‡∏≠‡∏Ñ‡∏£‡∏±‡∏ß‡∏ó‡∏≥‡∏û‡∏•‡∏≤‡∏î‡∏ï‡∏≠‡∏ô‡∏•‡∏ö‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û: $e');
      _setError('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏Ñ‡πà‡∏∞: $e');
      _setLoading(false);
      return false; // ‡∏•‡∏ö‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß
    }
  }

  /// ‡πÄ‡∏°‡∏ò‡∏≠‡∏î‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö "‡∏•‡∏ö‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤" ‡∏ó‡∏±‡πâ‡∏á‡∏Å‡πâ‡∏≠‡∏ô
  Future<bool> deleteTreatment(String patientId, String treatmentId) async {
    _setLoading(true);
    _setError(null);
    try {
      await _treatmentService.deleteTreatment(patientId, treatmentId);
      _setLoading(false);
      return true;
    } catch (e) {
      debugPrint('üßë‚Äçüç≥‚ùå ‡∏û‡πà‡∏≠‡∏Ñ‡∏£‡∏±‡∏ß‡∏ó‡∏≥‡∏û‡∏•‡∏≤‡∏î‡∏ï‡∏≠‡∏ô‡∏•‡∏ö: $e');
      _setError('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏∞: $e');
      _setLoading(false);
      return false;
    }
  }
}
